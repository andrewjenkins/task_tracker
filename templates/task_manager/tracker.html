{% extends "task_manager/base.html" %}
{% load static %}
{% block head %}
    <script type="text/javascript">
        // items
        $( function() {
            $( ".list" ).sortable({
                revert: true,
                connectWith: '.list',
                update: function (event, ui) {
                    var order_data = {
                        "items": $(this).sortable('serialize'),
                        "csrfmiddlewaretoken": "{{ csrf_token }}"
                    };

                    // make sure we only send one group change request
                    if (this !== ui.item.parent()[0]) {
                        var group_data = {
                            "item_id": ui.item.attr('id').substr(5),
                            "group_id": ui.item.parent().attr('id').substr(5),
                            "csrfmiddlewaretoken": "{{ csrf_token }}"
                        };

                        $.ajax({
                            data: group_data,
                            type: 'POST',
                            url: '{%  url 'item_move' %}'
                        });
                    }

                    $.ajax({
                        data: order_data,
                        type: 'POST',
                        url: '{% url 'group_order' %}'
                    });
                }
            });
            $( ".item" ).disableSelection();
        });

        // groups
        $( function() {
            $( "#content" ).sortable({
                revert: true,
                update: function (event, ui) {
                    var order_data = {
                        "groups": $(this).sortable('serialize'),
                        "csrfmiddlewaretoken": "{{ csrf_token }}"
                    };

                    $.ajax({
                        data: order_data,
                        type: 'POST',
                        url: '{% url 'board_order' %}'
                    });
                }
            });
            $( ".header" ).disableSelection();
        });

        $( function() {
            $('.delete_item').click(function (e) {
                e.preventDefault();
                $(this).parent().hide();
            });
        })();
    </script>
{% endblock %}

{% block content %}
    {% for group in groups %}
    <div id="group_{{ group.id }}" class="group ui card">
        <div class="content">
            <div class="header">{{ group.name|striptags }}</div>
            <div class="description">
                <div id="list_{{ group.id }}" class="ui list">
                    {% for item in group.item_set.all %}
                        <div id="item_{{ item.id }}" class="ui item segment">
                            {{ item.content|striptags }}
                            <a class="delete_item" href="#"><i class="remove circle red icon"></i></a>
                        </div>
                    {% endfor %}
                </div>
                <form action="{% url 'item_add' %}" class="ui action input" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="group_id" value="{{ group.id }}" />
                    <input type="text" name="content" placeholder="Add a new item..."/>
                    <button class="ui icon button">
                        <i class="plus icon"></i>
                    </button>
                </form>
            </div>
        </div>
        <!--<div class="extra content">
            TODO: add options to delete group
        </div>-->
    </div>
    {% endfor %}
    <div class="group ui card">
        <div class="content">
            <div class="description">
                <form action="{% url 'group_add' %}" class="ui action input" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="board_id" value="{{ board.id }}" />
                    <input type="text" name="group_name" placeholder="Add a new group..." maxlength="64" />
                    <button class="ui icon button">
                        <i class="plus icon"></i>
                    </button>
                </form>
            </div>
        </div>
        <!--<div class="extra content">
            TODO: add options to delete group
        </div>-->
    </div>
{% endblock %}